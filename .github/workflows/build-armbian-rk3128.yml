name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          git bash bc binfmt-support bison bsdmainutils build-essential \
          ca-certificates cmake cpio curl debootstrap device-tree-compiler \
          dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf \
          gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged \
          imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev \
          liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev \
          linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server \
          p7zip-full parted patchutils pkg-config psmisc python3 python3-dev \
          python3-distutils python3-pip python3-venv qemu-user-static rsync \
          swig systemd-container u-boot-tools udev unzip uuid-dev whiptail \
          wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework (主分支最新版)
      run: git clone --depth=1 https://github.com/armbian/build.git armbian-build

    - name: Copy custom configuration
      run: cp $CUSTOM_CONFIG armbian-build/config/boards/rock64.conf.override

    - name: Prepare kernel config for RK3128
      run: |
        cd armbian-build
        mkdir -p userpatches
        
        # 创建内核配置补丁
        cat > userpatches/kernel-rockchip-legacy.config << 'EOF'
        # RK3128 专用内核配置
        CONFIG_ROCKCHIP_RK3128=y
        CONFIG_MACH_RK3128=y
        CONFIG_CPU_RK312X=y
        CONFIG_SERIAL_8250=y
        CONFIG_SERIAL_8250_CONSOLE=y
        CONFIG_SERIAL_OF_PLATFORM=y
        CONFIG_MMC_DW=y
        CONFIG_MMC_DW_ROCKCHIP=y
        CONFIG_MMC_DW_IDMAC=y
        CONFIG_RTC_DRV_RK808=y
        # USB 支持
        CONFIG_USB=y
        CONFIG_USB_SUPPORT=y
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_XHCI_PLATFORM=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_EHCI_HCD_PLATFORM=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_OHCI_HCD_PLATFORM=y
        CONFIG_USB_PRINTER=y
        CONFIG_USB_STORAGE=y
        CONFIG_USB_UAS=y
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_SIMPLE=y
        CONFIG_USB_ACM=y
        # 网络支持
        CONFIG_NETDEVICES=y
        CONFIG_ETHERNET=y
        CONFIG_NET_VENDOR_REALTEK=y
        CONFIG_R8169=y
        CONFIG_RTL_CARDS=y
        CONFIG_WLAN=y
        CONFIG_RFKILL=y
        CONFIG_CFG80211=y
        CONFIG_MAC80211=y
        CONFIG_RTLWIFI=y
        CONFIG_RTL8192CU=y
        CONFIG_RTL8XXXU=y
        # 关闭不需要的功能
        # CONFIG_SOUND=n
        # CONFIG_DRM=n
        EOF

    - name: Create printer setup script
      run: |
        cd armbian-build
        mkdir -p userpatches/customize-image.d
        
        cat > userpatches/customize-image.d/99-rk3128-printer.sh << 'EOF'
        #!/bin/bash
        echo "正在配置 RK3128 打印机服务器..."
        
        # 安装打印服务
        apt-get update
        apt-get install -y \
          cups cups-client cups-filters cups-bsd \
          cups-pdf printer-driver-all hplip \
          sane sane-utils avahi-daemon
        
        # 配置 CUPS
        cupsctl --remote-any --remote-admin --share-printers
        usermod -a -G lpadmin root
        
        # 创建管理脚本
        cat > /usr/local/bin/printer-manage << 'SCRIPT_EOF'
        #!/bin/bash
        echo "RK3128 打印机管理"
        echo "1. 查看打印机状态"
        echo "2. 添加 USB 打印机"
        echo "3. 添加网络打印机"
        echo "4. 重启打印服务"
        echo "5. 打印测试页"
        read -p "选择操作: " choice
        
        case $choice in
          1)
            lpstat -p -d
            ;;
          2)
            echo "可用的 USB 打印机:"
            lpinfo -v | grep usb
            read -p "输入打印机名称: " name
            read -p "输入设备 URI: " uri
            lpadmin -p "$name" -E -v "$uri" -m everywhere
            ;;
          3)
            read -p "输入打印机名称: " name
            read -p "输入 IP 地址: " ip
            lpadmin -p "$name" -E -v "socket://$ip" -m everywhere
            ;;
          4)
            systemctl restart cups
            systemctl restart avahi-daemon
            echo "服务已重启"
            ;;
          5)
            echo "测试打印页" | lp
            echo "测试页已发送"
            ;;
        esac
        SCRIPT_EOF
        
        chmod +x /usr/local/bin/printer-manage
        
        echo "打印机服务器配置完成!"
        echo "Web 管理界面: http://$(hostname -I | cut -d' ' -f1):631"
        EOF
        
        chmod +x userpatches/customize-image.d/99-rk3128-printer.sh

    - name: Build Armbian for RK3128
      run: |
        cd armbian-build
        ./compile.sh \
          BOARD=$TARGET_BOARD \
          BRANCH=legacy \
          RELEASE=jammy \
          BUILD_MINIMAL=yes \
          BUILD_DESKTOP=no \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          EXPERT=yes \
          CLEAN_LEVEL="make,debs"

    - name: Rename output to RK3128
      run: |
        cd armbian-build/output/images
        for img in Armbian*.img; do
          if [ -f "$img" ]; then
            newname=$(echo "$img" | sed 's/rock64/rk3128-printer/')
            mv "$img" "$newname"
          fi
        done
        for sha in Armbian*.sha; do
          if [ -f "$sha" ]; then
            newname=$(echo "$sha" | sed 's/rock64/rk3128-printer/')
            mv "$sha" "$newname"
          fi
        done

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-firmware
        path: armbian-build/output/images/Armbian_rk3128-printer_*.img
        retention-days: 30

    - name: Upload checksum
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-checksums
        path: armbian-build/output/images/Armbian_rk3128-printer_*.sha
        retention-days: 30
