name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Kernel Version'
        required: true
        default: 'legacy'
        type: choice
        options:
          - legacy
          - current
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'

env:
  BUILD_ARMBIAN_VERSION: 24.5.1
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf
  BRANCH: legacy

jobs:
  build-rk3128:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git bash bc binfmt-support bison bsdmainutils build-essential ca-certificates cmake cpio curl debootstrap device-tree-compiler dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server p7zip-full parted patchutils pkg-config psmisc python3 python3-dev python3-distutils python3-pip python3-venv qemu-user-static rsync swig systemd-container u-boot-tools udev unzip uuid-dev whiptail wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework
      run: git clone --depth=1 --branch=$BUILD_ARMBIAN_VERSION https://github.com/armbian/build.git armbian-build

    - name: Prepare RK3128 configuration
      run: |
        cd armbian-build
        # 复制自定义配置文件
        cp ../$CUSTOM_CONFIG config/boards/rock64.conf.override
        # 创建用户补丁目录
        mkdir -p userpatches

    - name: Create RK3128 kernel config patch
      run: |
        cd armbian-build
        cat > userpatches/kernel-rockchip-legacy.config << 'EOF'
        CONFIG_ROCKCHIP_RK3128=y
        CONFIG_CPU_RK312X=y
        CONFIG_MACH_RK3126=y
        CONFIG_MACH_RK3128=y
        CONFIG_SERIAL_8250=y
        CONFIG_SERIAL_8250_CONSOLE=y
        CONFIG_SERIAL_OF_PLATFORM=y
        CONFIG_MMC_DW=y
        CONFIG_MMC_DW_ROCKCHIP=y
        CONFIG_MMC_DW_IDMAC=y
        CONFIG_RTC_DRV_RK808=y
        CONFIG_USB=y
        CONFIG_USB_SUPPORT=y
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_XHCI_PLATFORM=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_EHCI_HCD_PLATFORM=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_OHCI_HCD_PLATFORM=y
        CONFIG_USB_PRINTER=y
        CONFIG_USB_STORAGE=y
        CONFIG_USB_UAS=y
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_SIMPLE=y
        CONFIG_USB_ACM=y
        CONFIG_NETDEVICES=y
        CONFIG_ETHERNET=y
        CONFIG_NET_VENDOR_REALTEK=y
        CONFIG_R8169=y
        CONFIG_R8168=y
        CONFIG_RTL_CARDS=y
        CONFIG_WLAN=y
        CONFIG_RFKILL=y
        CONFIG_CFG80211=y
        CONFIG_MAC80211=y
        CONFIG_RTLWIFI=y
        CONFIG_RTL8192CU=y
        CONFIG_RTL8XXXU=y
        CONFIG_VIDEO_ROCKCHIP=y
        CONFIG_ROCKCHIP_DRM=y
        CONFIG_DRM_ROCKCHIP=y
        CONFIG_ROCKCHIP_ANALOGIX_DP=y
        CONFIG_SND_SOC_ROCKCHIP=y
        CONFIG_SND_SOC_ROCKCHIP_I2S=y
        CONFIG_SND_SOC_ROCKCHIP_MAX98090=y
        CONFIG_SND_SOC_RK312X=y
        CONFIG_DRM_PANEL_SIMPLE=y
        CONFIG_DRM_DW_HDMI=y
        CONFIG_DRM_DW_HDMI_ROCKCHIP=y
        CONFIG_REGULATOR=y
        CONFIG_REGULATOR_FIXED_VOLTAGE=y
        CONFIG_REGULATOR_GPIO=y
        CONFIG_REGULATOR_PWM=y
        CONFIG_REGULATOR_RK808=y
        CONFIG_PWM_ROCKCHIP=y
        CONFIG_COMMON_CLK_ROCKCHIP=y
        CONFIG_CLK_RK3128=y
        CONFIG_ROCKCHIP_IOMMU=y
        CONFIG_ROCKCHIP_PM_DOMAINS=y
        CONFIG_PHY_ROCKCHIP_INNO_HDMI=y
        CONFIG_PHY_ROCKCHIP_INNO_USB2=y
        CONFIG_ARM_ROCKCHIP_CPUFREQ=y
        CONFIG_THERMAL=y
        CONFIG_ROCKCHIP_THERMAL=y
        # 关闭不需要的功能
        CONFIG_SOUND=n
        CONFIG_FB=n
        CONFIG_VGA_CONSOLE=n
        CONFIG_LOGO=n
        CONFIG_DRM_LEGACY=n
        CONFIG_FRAMEBUFFER_CONSOLE=n
        EOF

    - name: Create printer server setup script
      run: |
        cd armbian-build
        mkdir -p userpatches/customize-image.d
        cat > userpatches/customize-image.d/99-setup-printer-server.sh << 'EOF'
        #!/bin/bash
        echo "设置 RK3128 打印机服务器..."
        
        # 更新软件源
        apt-get update
        
        # 安装 CUPS 和相关打印驱动
        apt-get install -y cups cups-client cups-filters cups-bsd cups-pdf printer-driver-all hplip sane sane-utils avahi-daemon avahi-discover
        
        # 配置 CUPS
        usermod -a -G lpadmin root
        cupsctl --remote-any --remote-admin --share-printers
        
        # 创建 CUPS 配置文件
        cat > /etc/cups/cupsd.conf << 'CUPS_EOF'
        LogLevel warn
        MaxLogSize 0
        Listen localhost:631
        Listen /var/run/cups/cups.sock
        Browsing On
        BrowseLocalProtocols dnssd
        DefaultAuthType Basic
        WebInterface Yes
        <Location />
          Order allow,deny
          Allow @LOCAL
          Allow 192.168.0.0/16
          Allow 10.0.0.0/8
          Allow 172.16.0.0/12
        </Location>
        <Location /admin>
          Order allow,deny
          Allow @LOCAL
          Allow 192.168.0.0/16
        </Location>
        <Policy default>
          JobPrivateAccess default
          JobPrivateValues default
          SubscriptionPrivateAccess default
          SubscriptionPrivateValues default
          <Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Get-Document>
            Require user @OWNER @SYSTEM
          </Limit>
          <Limit All>
            Order deny,allow
          </Limit>
        </Policy>
        CUPS_EOF
        
        # 启用服务
        systemctl enable cups
        systemctl enable cups-browsed
        systemctl enable avahi-daemon
        
        # 创建管理脚本
        cat > /usr/local/bin/printer-setup << 'SCRIPT_EOF'
        #!/bin/bash
        echo "=== RK3128 打印机服务器管理 ==="
        echo "1. 添加 USB 打印机"
        echo "2. 添加网络打印机"
        echo "3. 查看打印机状态"
        echo "4. 重启打印服务"
        echo "5. 测试打印"
        echo "6. 退出"
        read -p "选择: " choice
        
        case $choice in
          1)
            echo "检测 USB 打印机..."
            lpinfo -v | grep usb
            read -p "输入 USB 设备 URI: " usb_uri
            read -p "输入打印机名称: " printer_name
            lpadmin -p $printer_name -E -v $usb_uri -m everywhere
            echo "USB 打印机已添加"
            ;;
          2)
            read -p "输入打印机 IP 地址: " printer_ip
            read -p "输入打印机名称: " printer_name
            lpadmin -p $printer_name -E -v socket://$printer_ip -m everywhere
            echo "网络打印机已添加"
            ;;
          3)
            echo "打印机状态:"
            lpstat -p -d
            echo -e "\n打印队列:"
            lpstat -o
            ;;
          4)
            systemctl restart cups
            systemctl restart cups-browsed
            echo "打印服务已重启"
            ;;
          5)
            echo "测试页内容" | lp
            echo "测试页已发送到默认打印机"
            ;;
          6)
            exit 0
            ;;
          *)
            echo "无效选择"
            ;;
        esac
        SCRIPT_EOF
        
        chmod +x /usr/local/bin/printer-setup
        
        # 创建网络配置脚本
        cat > /usr/local/bin/setup-network << 'NET_EOF'
        #!/bin/bash
        echo "网络配置:"
        echo "1. 使用 DHCP (自动获取 IP)"
        echo "2. 设置静态 IP"
        read -p "选择: " net_choice
        
        case $net_choice in
          1)
            nmcli connection delete Wired 2>/dev/null || true
            nmcli connection add type ethernet con-name Wired ifname eth0
            nmcli connection modify Wired ipv4.method auto
            nmcli connection up Wired
            echo "DHCP 已启用"
            ;;
          2)
            read -p "IP 地址 (如 192.168.1.100): " ip_addr
            read -p "网关 (如 192.168.1.1): " gateway
            read -p "DNS (如 8.8.8.8): " dns_server
            nmcli connection delete Wired 2>/dev/null || true
            nmcli connection add type ethernet con-name Wired ifname eth0
            nmcli connection modify Wired ipv4.addresses $ip_addr/24
            nmcli connection modify Wired ipv4.gateway $gateway
            nmcli connection modify Wired ipv4.dns $dns_server
            nmcli connection modify Wired ipv4.method manual
            nmcli connection up Wired
            echo "静态 IP 已设置"
            ;;
          *)
            echo "无效选择"
            ;;
        esac
        NET_EOF
        
        chmod +x /usr/local/bin/setup-network
        
        # 创建启动信息
        cat > /etc/issue << 'ISSUE_EOF'
        ========================================
        RK3128 打印机服务器
        ========================================
        系统信息: Armbian $(lsb_release -d -s)
        内核版本: $(uname -r)
        IP 地址: $(hostname -I | cut -d' ' -f1)
        
        管理界面: http://$(hostname -I | cut -d' ' -f1):631
        SSH 登录: ssh root@$(hostname -I | cut -d' ' -f1)
        
        可用命令:
          printer-setup    - 配置打印机
          setup-network    - 配置网络
          cupsctl          - CUPS 配置
        
        ========================================
        ISSUE_EOF
        
        cp /etc/issue /etc/issue.net
        
        echo "打印机服务器配置完成!"
        echo "请访问 http://<设备IP>:631 进行管理"
        EOF
        
        chmod +x userpatches/customize-image.d/99-setup-printer-server.sh

    - name: Create RK3128 device tree overlay
      run: |
        cd armbian-build
        mkdir -p userpatches/overlay/boot/dtb/rockchip
        # 创建设备树补丁文件
        cat > userpatches/overlay/boot/dtb/rockchip/rk3128-overlay.dts << 'DTS_EOF'
        /dts-v1/;
        /plugin/;
        
        / {
            compatible = "rockchip,rk3128";
            
            fragment@0 {
                target-path = "/";
                __overlay__ {
                    gpio-keys {
                        compatible = "gpio-keys";
                        power {
                            label = "Power";
                            gpios = <&gpio2 RK_PA6 GPIO_ACTIVE_LOW>;
                            linux,code = <116>;
                            debounce-interval = <100>;
                        };
                    };
                };
            };
            
            fragment@1 {
                target = <&usb_host0_ehci>;
                __overlay__ {
                    status = "okay";
                };
            };
            
            fragment@2 {
                target = <&usb_host1_ohci>;
                __overlay__ {
                    status = "okay";
                };
            };
            
            fragment@3 {
                target = <&uart2>;
                __overlay__ {
                    status = "okay";
                };
            };
        };
        DTS_EOF

    - name: Build Armbian for RK3128
      run: |
        cd armbian-build
        # 使用 rock64 作为基础板型，但应用我们的自定义配置
        ./compile.sh \
          BOARD=rock64 \
          BRANCH=legacy \
          RELEASE=jammy \
          BUILD_MINIMAL=yes \
          BUILD_DESKTOP=no \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BSPFREEZE=yes \
          EXTRAWIFI=no \
          EXTERNAL=no \
          INSTALL_HEADERS=no \
          COMPRESS_OUTPUTIMAGE=sha,gz,img

    - name: Rename output files to RK3128
      run: |
        cd armbian-build/output/images
        for file in Armbian*.img Armbian*.sha; do
          if [ -f "$file" ]; then
            newname=$(echo "$file" | sed 's/Armbian_rock64_/Armbian_rk3128_printer_/')
            mv "$file" "$newname"
          fi
        done

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-server
        path: |
          armbian-build/output/images/*.img
          armbian-build/output/images/*.sha
        retention-days: 30

    - name: Create release on tag
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: armbian-build/output/images/*.img
        body: |
          # RK3128 打印机服务器 Armbian 镜像
          
          ## 版本信息
          - 基于 Armbian 24.5.1 (Ubuntu Jammy)
          - Linux 内核 5.10 (legacy)
          - 预装完整打印服务器功能
          
          ## 刷机说明
          1. 使用 RKDevelopTool 或 AndroidTool 刷机
          2. 短接主板上的 eMMC CLK 和 GND 引脚进入 MaskROM 模式
          3. 加载镜像并刷写
          
          ## 默认登录
          - SSH: root / 1234 (首次登录需修改)
          - Web: http://[设备IP]:631
          
          ## 功能
          - CUPS 打印服务器
          - USB 打印机支持
          - 网络打印机支持
          - Avahi 打印机发现
          - Web 管理界面

    - name: Clean up
      if: always()
      run: |
        echo "清理临时文件..."
        rm -rf armbian-build/output/buildpkg
        rm -rf armbian-build/.tmp
        sudo rm -rf /tmp/*
