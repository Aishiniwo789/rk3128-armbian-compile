name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # 每周一凌晨2点自动构建

env:
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 编译可能耗时较长

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          git bash bc binfmt-support bison bsdmainutils build-essential \
          ca-certificates cmake cpio curl debootstrap device-tree-compiler \
          dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf \
          gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged \
          imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev \
          liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev \
          linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server \
          p7zip-full parted patchutils pkg-config psmisc python3 python3-dev \
          python3-distutils python3-pip python3-venv qemu-user-static rsync \
          swig systemd-container u-boot-tools udev unzip uuid-dev whiptail \
          wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework (使用 legacy 分支)
      run: git clone --depth=1 --branch=legacy https://github.com/armbian/build.git armbian-build

    - name: Copy custom configuration
      run: cp $CUSTOM_CONFIG armbian-build/config/boards/rock64.conf.override

    - name: Create userpatches directory
      run: |
        cd armbian-build
        mkdir -p userpatches/kernel/rockchip-legacy

    - name: Create RK3128 kernel config patch
      run: |
        cd armbian-build
        cat > userpatches/kernel/rockchip-legacy.config << 'EOF'
        # RK3128 专用内核配置
        CONFIG_ROCKCHIP_RK3128=y
        CONFIG_MACH_RK3128=y
        # USB 与打印机支持
        CONFIG_USB=y
        CONFIG_USB_SUPPORT=y
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_XHCI_PLATFORM=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_EHCI_HCD_PLATFORM=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_OHCI_HCD_PLATFORM=y
        CONFIG_USB_PRINTER=y
        CONFIG_USB_STORAGE=y
        CONFIG_USB_UAS=y
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_SIMPLE=y
        # 网络支持
        CONFIG_NETDEVICES=y
        CONFIG_ETHERNET=y
        CONFIG_NET_VENDOR_REALTEK=y
        CONFIG_R8169=y
        CONFIG_RTL_CARDS=y
        # 无线网络 (常见板载芯片)
        CONFIG_WLAN=y
        CONFIG_RFKILL=y
        CONFIG_CFG80211=y
        CONFIG_MAC80211=y
        CONFIG_RTLWIFI=y
        CONFIG_RTL8192CU=y
        CONFIG_RTL8XXXU=y
        # 存储
        CONFIG_MMC_DW=y
        CONFIG_MMC_DW_ROCKCHIP=y
        CONFIG_MMC_DW_IDMAC=y
        # 基础外设
        CONFIG_SERIAL_8250=y
        CONFIG_SERIAL_8250_CONSOLE=y
        CONFIG_SERIAL_OF_PLATFORM=y
        CONFIG_RTC_DRV_RK808=y
        # 关闭不需要的图形功能以减小体积
        # CONFIG_DRM=y
        # CONFIG_DRM_ROCKCHIP=y
        # CONFIG_SOUND=y
        EOF

    - name: Create printer server setup script
      run: |
        cd armbian-build
        mkdir -p userpatches/customize-image.d
        cat > userpatches/customize-image.d/99-setup-printer-server.sh << 'EOF'
        #!/bin/bash
        echo "=========================================="
        echo "  配置 RK3128 打印机服务器"
        echo "=========================================="
        
        # 更新并安装打印服务
        apt-get update
        apt-get install -y --no-install-recommends \
          cups cups-client cups-filters cups-bsd \
          cups-pdf printer-driver-all hplip \
          sane sane-utils avahi-daemon avahi-discover
        
        # 允许远程管理并共享打印机
        cupsctl --remote-any --remote-admin --share-printers
        usermod -a -G lpadmin root
        
        # 创建简易管理脚本
        cat > /usr/local/bin/printer-admin << 'SCRIPT_EOF'
        #!/bin/bash
        case "$1" in
          list)
            lpstat -p -d
            ;;
          add-usb)
            echo "可用USB设备:"
            lpinfo -v | grep usb
            if [ $# -eq 3 ]; then
              lpadmin -p "$2" -E -v "$3" -m everywhere
              echo "已添加打印机: $2"
            else
              echo "用法: printer-admin add-usb <名称> <设备URI>"
              echo "示例: printer-admin add-usb HP_Printer usb://HP/LaserJet"
            fi
            ;;
          add-network)
            if [ $# -eq 3 ]; then
              lpadmin -p "$2" -E -v "socket://$3" -m everywhere
              echo "已添加网络打印机: $2"
            else
              echo "用法: printer-admin add-network <名称> <IP地址>"
            fi
            ;;
          test)
            echo "CUPS打印机服务器测试页" | lp
            echo "测试页已发送"
            ;;
          restart)
            systemctl restart cups
            systemctl restart avahi-daemon
            echo "服务已重启"
            ;;
          *)
            echo "RK3128 打印机管理命令"
            echo "用法:"
            echo "  list                 - 列出打印机"
            echo "  add-usb <名> <URI>   - 添加USB打印机"
            echo "  add-network <名> <IP> - 添加网络打印机"
            echo "  test                 - 打印测试页"
            echo "  restart              - 重启打印服务"
            ;;
        esac
        SCRIPT_EOF
        
        chmod +x /usr/local/bin/printer-admin
        
        # 创建网络配置助手
        cat > /usr/local/bin/setup-network << 'NET_EOF'
        #!/bin/bash
        echo "网络配置助手"
        echo "当前IP地址:"
        hostname -I
        echo ""
        echo "有线网络:"
        nmcli connection show --active | grep ethernet || echo "未连接"
        echo ""
        echo "要配置网络，请使用:"
        echo "  nmtui          # 文本界面配置工具"
        echo "  nmcli          # 命令行配置工具"
        NET_EOF
        
        chmod +x /usr/local/bin/setup-network
        
        # 创建欢迎信息
        cat > /etc/issue << 'WELCOME_EOF'
        
        ==========================================
            RK3128 打印机服务器
        ==========================================
        系统: Armbian $(lsb_release -d -s)
        内核: $(uname -r)
        IP地址: $(hostname -I | cut -d' ' -f1)
        
        管理界面: http://$(hostname -I | cut -d' ' -f1):631
        SSH登录: ssh root@$(hostname -I | cut -d' ' -f1)
        
        常用命令:
          printer-admin     - 打印机管理
          setup-network     - 网络信息
          cupsctl           - CUPS配置
        
        ==========================================
        
        WELCOME_EOF
        
        cp /etc/issue /etc/issue.net
        
        echo "=========================================="
        echo "  打印机服务器配置完成!"
        echo "  请访问 http://<设备IP>:631 进行管理"
        echo "=========================================="
        EOF
        
        chmod +x userpatches/customize-image.d/99-setup-printer-server.sh

    - name: Build Armbian image
      run: |
        cd armbian-build
        ./compile.sh \
          BOARD=$TARGET_BOARD \
          BRANCH=legacy \
          RELEASE=jammy \
          BUILD_MINIMAL=yes \
          BUILD_DESKTOP=no \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BSPFREEZE=yes \
          EXPERT="yes"

    - name: Rename output files
      run: |
        cd armbian-build/output/images
        for file in Armbian*.img Armbian*.sha; do
          if [ -f "$file" ]; then
            newname=$(echo "$file" | sed 's/Armbian_rock64_/Armbian_rk3128_printer_/')
            mv "$file" "$newname" || true
          fi
        done
        ls -la *.img *.sha

    - name: Upload firmware image
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-server-image
        path: armbian-build/output/images/Armbian_rk3128_printer_*.img
        retention-days: 30

    - name: Upload checksum file
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-checksums
        path: armbian-build/output/images/Armbian_rk3128_printer_*.sha
        retention-days: 30
