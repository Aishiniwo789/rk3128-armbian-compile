name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          git bash bc binfmt-support bison bsdmainutils build-essential \
          ca-certificates cmake cpio curl debootstrap device-tree-compiler \
          dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf \
          gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged \
          imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev \
          liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev \
          linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server \
          p7zip-full parted patchutils pkg-config psmisc python3 python3-dev \
          python3-distutils python3-pip python3-venv qemu-user-static rsync \
          swig systemd-container u-boot-tools udev unzip uuid-dev whiptail \
          wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework
      run: git clone --depth=1 https://github.com/armbian/build.git armbian-build

    - name: Copy custom configuration
      run: cp $CUSTOM_CONFIG armbian-build/config/boards/rock64.conf.override

    - name: Create essential RK3128 patches
      run: |
        cd armbian-build
        
        # 1. 创建内核配置强制降级补丁
        mkdir -p userpatches
        cat > userpatches/kernel-rockchip-current.config << 'EOF'
        # 强制启用 RK3128 支持
        CONFIG_ROCKCHIP_RK3128=y
        CONFIG_MACH_RK3128=y
        CONFIG_CPU_RK312X=y
        # 关键：强制使用旧版 USB 驱动架构（兼容打印机）
        CONFIG_USB=y
        CONFIG_USB_SUPPORT=y
        CONFIG_USB_PRINTER=y
        CONFIG_USB_PRINTER=m
        CONFIG_USB_STORAGE=y
        CONFIG_USB_UAS=y
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_SIMPLE=y
        # 启用所有必要的 USB 主机控制器
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_XHCI_PLATFORM=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_EHCI_HCD_PLATFORM=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_OHCI_HCD_PLATFORM=y
        # 网络驱动
        CONFIG_NETDEVICES=y
        CONFIG_ETHERNET=y
        CONFIG_NET_VENDOR_REALTEK=y
        CONFIG_R8169=y
        # 基础设备支持
        CONFIG_SERIAL_8250=y
        CONFIG_SERIAL_8250_CONSOLE=y
        CONFIG_SERIAL_OF_PLATFORM=y
        CONFIG_MMC_DW=y
        CONFIG_MMC_DW_ROCKCHIP=y
        CONFIG_MMC_DW_IDMAC=y
        CONFIG_RTC_DRV_RK808=y
        # 禁用可能导致问题的新特性
        # CONFIG_ARM64_VA_BITS_48=n
        # CONFIG_RANDOMIZE_BASE=n
        EOF
        
        # 2. 创建强制使用旧版 U-Boot 的补丁脚本
        mkdir -p userpatches/overlay
        cat > userpatches/overlay/force-old-uboot.sh << 'EOF'
        #!/bin/bash
        echo "确保使用兼容 RK3128 的 U-Boot 配置..."
        # 此脚本会在构建过程中被调用，确保使用正确的配置
        EOF
        chmod +x userpatches/overlay/force-old-uboot.sh

    - name: Create minimal printer setup script
      run: |
        cd armbian-build
        mkdir -p userpatches/customize-image.d
        
        cat > userpatches/customize-image.d/10-rk3128-essentials.sh << 'EOF'
        #!/bin/bash
        echo "安装 RK3128 基本打印机支持..."
        
        # 安装绝对必要的包
        apt-get update
        apt-get install -y --no-install-recommends \
          cups cups-client cups-filters \
          printer-driver-all \
          avahi-daemon
        
        # 基础配置
        cupsctl --remote-any --share-printers
        usermod -a -G lpadmin root
        
        # 极简管理脚本
        cat > /usr/local/bin/cups-status << 'SCRIPT_EOF'
        #!/bin/bash
        echo "CUPS 状态:"
        systemctl status cups | grep -E "(Active|Loaded)"
        echo ""
        echo "打印机:"
        lpstat -p 2>/dev/null || echo "未检测到打印机"
        echo ""
        echo "管理界面: http://$(hostname -I | cut -d' ' -f1):631"
        SCRIPT_EOF
        
        chmod +x /usr/local/bin/cups-status
        
        echo "基本打印服务已安装。使用 'cups-status' 查看状态。"
        EOF
        
        chmod +x userpatches/customize-image.d/10-rk3128-essentials.sh

    - name: Build with explicit settings
      run: |
        cd armbian-build
        # 使用最简化的构建命令，避免冲突
        ./compile.sh \
          BOARD=$TARGET_BOARD \
          BRANCH=current \
          RELEASE=jammy \
          BUILD_MINIMAL=yes \
          BUILD_DESKTOP=no \
          KERNEL_CONFIGURE=yes \
          EXPERT=yes \
          CLEAN_LEVEL="none"

    - name: 处理并重命名输出
: |
        cd armbian-build/output/images
        # 重命名文件以清晰标识
        for file in Armbian*.img; do
          if [ -f "$file" ]; 然后
            newname="RK3128_Printer_Server_${file#Armbian_}"
            mv "$file" "$newname"
            echo "已重命名为: $newname"
          fi
        done
        ls -la *.img *.sha

    - name: Upload firmware image
      uses: actions/upload-artifact@v4
与:
名称: rk3128-printer-firmware
        path: armbian-build/output/images/RK3128_Printer_Server_*.img
保留天数: 30

    - 名称: 上传校验和
      uses: actions/upload-artifact@v4
与:
名称: rk3128-checksums
路径: armbian-build/output/images/RK3128_Printer_Server_*.sha
保留天数: 30
