name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git bash bc binfmt-support bison bsdmainutils build-essential ca-certificates cmake cpio curl debootstrap device-tree-compiler dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server p7zip-full parted patchutils pkg-config psmisc python3 python3-dev python3-distutils python3-pip python3-venv qemu-user-static rsync swig systemd-container u-boot-tools udev unzip uuid-dev whiptail wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework
      run: git clone --depth=1 https://github.com/armbian/build.git armbian-build

    - name: 复制自定义配置
运行: cp $CUSTOM_CONFIG armbian-build/config/boards/rock64.conf.override

    - 名称: 创建必要的RK3128补丁
: cd armbian-build && mkdir -p userpatches && echo“# 强制启用 RK3128 支持”> userpatches/kernel-rockchip-current.config && echo"CONFIG_ROCKCHIP_RK3128=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_MACH_RK3128=y">> userpatches/kernel-rockchip-current.config && echoCONFIG_CPU_RK312X=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_SUPPORT=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_PRINTER=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_PRINTER=m>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_STORAGE=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_UAS=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_SERIAL=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_SERIAL_SIMPLE=y>> userpatches/kernel-rockchip-current.config && echoCONFIG_USB_XHCI_HCD=y>> userpatches/kernel-rockchip-current.config && echo"CONFIG_USB_XHCI_PLATFORM=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_USB_EHCI_HCD=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_USB_EHCI_HCD_PLATFORM=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_USB_OHCI_HCD=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_USB_OHCI_HCD_PLATFORM=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_NETDEVICES=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_ETHERNET=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_NET_VENDOR_REALTEK=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_R8169=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_SERIAL_8250=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_SERIAL_8250_CONSOLE=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_SERIAL_OF_PLATFORM=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_MMC_DW=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_MMC_DW_ROCKCHIP=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_MMC_DW_IDMAC=y">> userpatches/kernel-rockchip-current.config && echo"CONFIG_RTC_DRV_RK808=y">> userpatches/kernel-rockchip-current.config

    - 名称: 创建最小打印机设置脚本
"#!/bin/bash"> userpatches/customize-image.d/10-rk3128-essentials.sh && echo"echo '安装 RK3128 基本打印机支持...'">> userpatches/customize-image.d/10-rk3128-essentials.sh && echo“apt-get update”“apt-get install -y --no-install-recommends cups cups-client cups-filters printer-driver-all avahi-daemon”“cupsctl --remote-any --share-printers”“usermod -a -G lpadmin root”“cat > /usr/local/bin/cups-status << 'SCRIPTEOF'”“echo 'CUPS 状态：'”“systemctl status cups | grep -E '(Active|Loaded)'”“echo ''”“echo '打印机：'”“lpstat -p 2>/dev/null || echo '未检测到打印机'”“echo '管理界面：http://$(hostname -I | cut -d\"\\n\" -f1):631'”“SCRIPTEOF”chmod +x /usr/local/bin/cups-statusecho '基本打印服务已安装。使用 cups-status 查看状态。'>> userpatches/customize-image.d/10-rk3128-essentials.sh && chmod +x userpatches/customize-image.d/10-rk3128-essentials.sh

    - 名称: 使用显式设置构建
: cd armbian-build && ./compile.sh BOARD=$TARGET_BOARD BRANCH=current RELEASE=jammy BUILD_MINIMAL=yes BUILD_DESKTOP=no KERNEL_CONFIGURE=yes EXPERT=yes CLEAN_LEVEL=none

    - name: 处理并重命名输出
: cd armbian-build/output/images && for file in Armbian*.img; do if[-f ]$newname"

    - name: 上传固件镜像
使用: actions/upload-artifact@v4
与:
名称: rk3128-打印机固件
路径: armbian-build/output/images/RK3128_Printer_Server_*.img
保留天数: 30

    - 名称: 上传校验和
使用: actions/upload-artifact@v4
与:
名称: rk3128-checksums
路径: armbian-build/output/images/RK3128_Printer_Server_*.sha
保留天数: 30
