name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

env:
  TARGET_BOARD: rock64
  CUSTOM_CONFIG: rk3128-custom.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: sudo apt-get update && sudo DEBIAN_FRONTEND=noninteractive apt-get install -y git bash bc binfmt-support bison bsdmainutils build-essential ca-certificates cmake cpio curl debootstrap device-tree-compiler dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server p7zip-full parted patchutils pkg-config psmisc python3 python3-dev python3-distutils python3-pip python3-venv qemu-user-static rsync swig systemd-container u-boot-tools udev unzip uuid-dev whiptail wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework
      run: git clone --depth=1 https://github.com/armbian/build.git armbian-build

    - name: Copy custom configuration
      run: cp $CUSTOM_CONFIG armbian-build/config/boards/rock64.conf.override

    - name: Create essential RK3128 patches
      run: cd armbian-build && mkdir -p userpatches && echo "# 强制启用 RK3128 支持" > userpatches/kernel-rockchip-current.config && echo "CONFIG_ROCKCHIP_RK3128=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_MACH_RK3128=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_CPU_RK312X=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_SUPPORT=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_PRINTER=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_PRINTER=m" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_STORAGE=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_UAS=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_SERIAL=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_SERIAL_SIMPLE=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_XHCI_HCD=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_XHCI_PLATFORM=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_EHCI_HCD=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_EHCI_HCD_PLATFORM=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_OHCI_HCD=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_USB_OHCI_HCD_PLATFORM=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_NETDEVICES=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_ETHERNET=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_NET_VENDOR_REALTEK=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_R8169=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_SERIAL_8250=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_SERIAL_8250_CONSOLE=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_SERIAL_OF_PLATFORM=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_MMC_DW=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_MMC_DW_ROCKCHIP=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_MMC_DW_IDMAC=y" >> userpatches/kernel-rockchip-current.config && echo "CONFIG_RTC_DRV_RK808=y" >> userpatches/kernel-rockchip-current.config

    - name: Create minimal printer setup script
      run: cd armbian-build && mkdir -p userpatches/customize-image.d && echo '#!/bin/bash' > userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo "安装 RK3128 基本打印机支持..."' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'apt-get update' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'apt-get install -y --no-install-recommends cups cups-client cups-filters printer-driver-all avahi-daemon' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'cupsctl --remote-any --share-printers' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'usermod -a -G lpadmin root' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'cat > /usr/local/bin/cups-status << "SCRIPTEOF"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo '#!/bin/bash' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo "CUPS 状态:"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'systemctl status cups | grep -E "(Active|Loaded)"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo ""' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo "打印机:"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'lpstat -p 2>/dev/null || echo "未检测到打印机"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo ""' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo "管理界面: http://$(hostname -I | cut -d" " -f1):631"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'SCRIPTEOF' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'chmod +x /usr/local/bin/cups-status' >> userpatches/customize-image.d/10-rk3128-essentials.sh && echo 'echo "基本打印服务已安装。使用 cups-status 查看状态。"' >> userpatches/customize-image.d/10-rk3128-essentials.sh && chmod +x userpatches/customize-image.d/10-rk3128-essentials.sh

    - name: Build with explicit settings
      run: cd armbian-build && ./compile.sh BOARD=$TARGET_BOARD BRANCH=current RELEASE=jammy BUILD_MINIMAL=yes BUILD_DESKTOP=no KERNEL_CONFIGURE=yes EXPERT=yes CLEAN_LEVEL=none

    - name: Process and rename output
      run: cd armbian-build/output/images && for file in Armbian*.img; do if [ -f "$file" ]; then newname="RK3128_Printer_Server_${file#Armbian_}"; mv "$file" "$newname"; echo "已重命名为: $newname"; fi; done && ls -la *.img *.sha

    - name: Upload firmware image
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-firmware
        path: armbian-build/output/images/RK3128_Printer_Server_*.img
        retention-days: 30

    - name: Upload checksums
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-checksums
        path: armbian-build/output/images/RK3128_Printer_Server_*.sha
        retention-days: 30
