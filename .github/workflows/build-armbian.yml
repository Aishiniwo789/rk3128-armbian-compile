name: Build Armbian for RK3128 Printer Server

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Armbian Version'
        required: true
        default: 'current'
        type: choice
        options:
        - current
        - legacy
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'

env:
  BUILD_ARMBIAN_VERSION: 24.5.1
  TARGET_BOARD: rk3128
  CONFIG_FILE: rk3128-printserver.conf

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup build environment
      run: sudo apt-get update && sudo apt-get install -y git bash bc binfmt-support bison bsdmainutils build-essential ca-certificates cmake cpio curl debootstrap device-tree-compiler dialog dosfstools f2fs-tools flex gawk gcc-arm-linux-gnueabihf gcc-arm-none-eabi gcc-x86-64-linux-gnu gdisk graphviz haveged imagemagick jq kmod libbison-dev libelf-dev libfdt-dev libfl-dev liblz4-tool libncurses-dev libpython3-dev libssl-dev libusb-1.0-0-dev linux-base locales lsof ncftp ncurses-base ncurses-term nfs-kernel-server p7zip-full parted patchutils pkg-config psmisc python3 python3-dev python3-distutils python3-pip python3-venv qemu-user-static rsync swig systemd-container u-boot-tools udev unzip uuid-dev whiptail wget xz-utils zip zlib1g-dev zstd

    - name: Clone Armbian build framework
      run: git clone --depth=1 https://github.com/armbian/build.git armbian-build

    - name: Copy custom configuration
      run: cp $CONFIG_FILE armbian-build/config/boards/

    - name: Prepare build directory
      run: cd armbian-build && mkdir -p output/userpatches

    - name: Create userpatches directory structure
      run: |
        cd armbian-build
        mkdir -p userpatches/overlay/{etc,usr,var}
        mkdir -p userpatches/customize-image.d

    - name: Create CUPS configuration overlay
      run: |
        cd armbian-build/userpatches/overlay
        mkdir -p etc/cups
        cat > etc/cups/cupsd.conf << 'EOF'
        LogLevel warn
        MaxLogSize 0
        Listen localhost:631
        Listen /var/run/cups/cups.sock
        Browsing On
        BrowseLocalProtocols dnssd
        DefaultAuthType Basic
        WebInterface Yes
        <Location />
          Order allow,deny
          Allow 192.168.0.0/16
          Allow 10.0.0.0/8
          Allow 172.16.0.0/12
        </Location>
        <Location /admin>
          Encryption Required
          Order allow,deny
          Allow 192.168.0.0/16
          Allow 10.0.0.0/8
          Allow 172.16.0.0/12
        </Location>
        <Location /admin/conf>
          AuthType Default
          Require user @SYSTEM
          Order allow,deny
          Allow 192.168.0.0/16
          Allow 10.0.0.0/8
          Allow 172.16.0.0/12
        </Location>
        <Policy default>
          JobPrivateAccess default
          JobPrivateValues default
          SubscriptionPrivateAccess default
          SubscriptionPrivateValues default
          <Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Get-Document>
            Require user @OWNER @SYSTEM
          </Limit>
          <Limit All>
            Order deny,allow
          </Limit>
        </Policy>
        EOF

    - name: Create printer server setup script
      run: |
        cd armbian-build/userpatches/customize-image.d
        cat > 99-setup-printer-server.sh << 'EOF'
        #!/bin/bash
        # RK3128 打印机服务器设置脚本
        
        echo "设置打印机服务器..."
        
        # 启用 CUPS 服务
        systemctl enable cups
        systemctl enable cups-browsed
        
        # 配置 CUPS 远程访问
        cupsctl --remote-admin --remote-any --share-printers
        
        # 添加用户到 lpadmin 组（允许管理打印机）
        usermod -a -G lpadmin root
        
        # 安装中文打印支持（如果需要）
        apt-get update
        apt-get install -y cups-filters-extra printer-driver-gutenprint printer-driver-cups-pdf
        
        # 配置 Avahi 用于打印机发现
        cat >> /etc/avahi/avahi-daemon.conf << 'AVAHI_EOF'
        [server]
        use-ipv4=yes
        use-ipv6=no
        ratelimit-interval-usec=1000000
        ratelimit-burst=1000
        
        [wide-area]
        enable-wide-area=yes
        
        [publish]
        publish-hinfo=no
        publish-workstation=no
        publish-domain=yes
        publish-addresses=yes
        publish-aaaa-on-ipv4=no
        publish-a-on-ipv6=no
        
        [reflector]
        
        [rlimits]
        AVAHI_EOF
        
        systemctl enable avahi-daemon
        
        # 创建打印机管理脚本
        cat > /usr/local/bin/printer-admin << 'SCRIPT_EOF'
        #!/bin/bash
        echo "RK3128 打印机服务器管理"
        echo "1. 添加网络打印机"
        echo "2. 添加 USB 打印机"
        echo "3. 查看打印机列表"
        echo "4. 设置默认打印机"
        echo "5. 重启打印服务"
        echo "6. 退出"
        read -p "选择操作 [1-6]: " choice
        
        case $choice in
            1)
                read -p "输入打印机IP地址: " printer_ip
                read -p "输入打印机型号: " printer_model
                lpadmin -p network_printer -E -v socket://$printer_ip -m $printer_model
                ;;
            2)
                echo "请确保USB打印机已连接..."
                lpinfo -v | grep usb
                read -p "输入USB设备URI: " usb_uri
                read -p "输入打印机名称: " printer_name
                lpadmin -p $printer_name -E -v $usb_uri -m everywhere
                ;;
            3)
                lpstat -p -d
                ;;
            4)
                read -p "输入默认打印机名称: " default_printer
                lpadmin -d $default_printer
                ;;
            5)
                systemctl restart cups
                systemctl restart cups-browsed
                echo "打印服务已重启"
                ;;
            6)
                exit 0
                ;;
            *)
                echo "无效选择"
                ;;
        esac
        SCRIPT_EOF
        
        chmod +x /usr/local/bin/printer-admin
        
        # 添加开机启动服务
        cat > /etc/systemd/system/printer-server-ready.service << 'SERVICE_EOF'
        [Unit]
        Description=Printer Server Ready Notification
        After=network-online.target cups.service
        Wants=network-online.target
        
        [Service]
        Type=oneshot
        ExecStart=/bin/bash -c "echo '打印机服务器已启动！CUPS管理界面: http://$(hostname -I | cut -d' ' -f1):631' > /etc/issue.net"
        RemainAfterExit=yes
        
        [Install]
        WantedBy=multi-user.target
        SERVICE_EOF
        
        systemctl enable printer-server-ready.service
        
        echo "打印机服务器配置完成！"
        echo "访问 http://[设备IP]:631 管理打印机"
        EOF
        chmod +x 99-setup-printer-server.sh

    - name: Create kernel configuration patch for RK3128
      run: |
        cd armbian-build/userpatches
        cat > kernel-rockchip-legacy.config << 'EOF'
        # RK3128 打印机服务器内核配置
        CONFIG_USB_PRINTER=y
        CONFIG_USB_SERIAL=y
        CONFIG_USB_SERIAL_GENERIC=y
        CONFIG_USB_SERIAL_SIMPLE=y
        CONFIG_USB_UHCI_HCD=y
        CONFIG_USB_OHCI_HCD=y
        CONFIG_USB_EHCI_HCD=y
        CONFIG_USB_XHCI_HCD=y
        CONFIG_USB_STORAGE=y
        CONFIG_USB_ANNOUNCE_NEW_DEVICES=y
        CONFIG_NETWORK_FILESYSTEMS=y
        CONFIG_CIFS=y
        CONFIG_NFS_FS=y
        CONFIG_NFS_V4=y
        CONFIG_IP_PNP=y
        CONFIG_IP_PNP_DHCP=y
        CONFIG_IP_PNP_BOOTP=y
        CONFIG_SERIAL_8250=y
        CONFIG_SERIAL_8250_CONSOLE=y
        CONFIG_SERIAL_OF_PLATFORM=y
        CONFIG_MMC_DW=y
        CONFIG_MMC_DW_ROCKCHIP=y
        CONFIG_RTC_DRV_RK808=y
        CONFIG_DRM_ROCKCHIP=y
        CONFIG_ROCKCHIP_ANALOGIX_DP=y
        CONFIG_SND_SOC_ROCKCHIP=y
        CONFIG_SND_SOC_ROCKCHIP_I2S=y
        CONFIG_SND_SOC_ROCKCHIP_MAX98090=y
        # 关闭不需要的功能节省空间
        CONFIG_SOUND=n
        CONFIG_DRM=n
        CONFIG_FB=n
        CONFIG_VGA_CONSOLE=n
        CONFIG_LOGO=n
        EOF

    - name: Build Armbian image
      run: |
        cd armbian-build
        ./compile.sh BOARD=$TARGET_BOARD BRANCH=legacy RELEASE=jammy BUILD_MINIMAL=yes BUILD_DESKTOP=no KERNEL_CONFIGURE=no EXTRAWIFI=no EXTERNAL=no INSTALL_HEADERS=no BSPFREEZE=yes

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rk3128-printer-server-armbian
        path: |
          armbian-build/output/images/*.img
          armbian-build/output/images/*.sha
        retention-days: 7

    - name: Upload to releases (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: armbian-build/output/images/*.img
